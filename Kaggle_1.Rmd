---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
credit_dat<-read.csv("Give_Me_Some_Credit.csv")
set.seed(101)
train<-sample(nrow(credit_dat),(2/3)*nrow(credit_dat))
credit_train<-credit_dat[train,]
Defaulter<-ifelse(credit_train$SeriousDlqin2yrs==0,"N","Y")
credit_train<-cbind.data.frame(credit_train,Defaulter)
attach(credit_train)


#Data Prep
#Calculating Mean(MonthlyIncome) according to agebins and replacing NA's with correponding values

age_Income<-function(train_data,limit,x=20){
  
  for(i in 1:(limit/10)){
    
    temp_mean<-mean(train_data[which((train_data$age                         %in% c(x:x+10))),"MonthlyIncome"],na.rm = TRUE)
      print(temp_mean)
      x=x+10
  }
}
#Unexpectedly RevolvingUtilizationofUnsecuredcreditlines>1 in some of th e rows which can be an anamoly
credit_train<-credit_train[-which(credit_train$RevolvingUtilizationOfUnsecuredLines>1),]
#Removing NA's from MonthlyIncome
credit_train<-credit_train[-which(is.na(credit_train$MonthlyIncome)),]
#Removing NA's from NumberOfDependents
credit_train<-credit_train[-which(is.na(credit_train$NumberOfDependents)),]

#Feature Selection
#Plotting heat map for testing correlation between features
require(ggplot2)
require(reshape2)
qplot(x=Var1,y=Var2,data=melt(cor(credit_train[,3:(ncol(credit_train)-1)],use="p")),fill=value,geom="tile")+scale_fill_gradient2(limits=c(1,-1)) #High correlation observed between 4 features.On basis of the heat map,selected only one amongst correlated features

#Using Boruta package for checking importance of variables
set.seed(123)
boruta.train<-Boruta(SeriousDlqin2yrs~.,data=credit_train,doTrace=2)
plot(boruta.train, xlab = "", xaxt = "n")
lz<-lapply(1:ncol(boruta.train$ImpHistory),function(i) boruta.train$ImpHistory[is.finite(boruta.train$ImpHistory[,i]),i])
names(lz)<-colnames(boruta.train$ImpHistory)
Labels<-sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),at=1:ncol(boruta.train$ImpHistory),cex.axis=.7)


#Fitting models
  
#Logistic Model
#Scaling Income and constructing model based on three 4 variables as shown,na.action=na.omit
log.mod<-glm(SeriousDlqin2yrs~age+scale(MonthlyIncome)+RevolvingUtilizationOfUnsecuredLines+NumberOfOpenCreditLinesAndLoans+NumberOfDependents+NumberOfTime60.89DaysPastDueNotWorse,data=credit_train,family = "binomial",na.action = na.omit)
#Creating a pred_data from credit_dat[-train,](represents 1/3rd of credit_dat and removing NA's)
pred_data<-pred_data[!is.na(pred_data$MonthlyIncome),]
#Checking if pred_data contains any NA
anyNA(pred_data)
#Converting SeriousDlqin2Yrs from pred_data into factor
pred_data$SeriousDlqin2yrs<-as.factor(pred_data$SeriousDlqin2yrs)
#Predicting on pred_data and using response as output which fetches probability
pred_log_mod<-predict(log.mod,newdata = pred_data,type = "response")
#Classifying defaulter if prob>.5
pred_Defaulter<-ifelse(pred_log_mod>.5,1,0)
pred_log_dat<-cbind(pred_log_mod,pred_Defaulter)
pred_log_dat<-as.data.frame(pred_log_dat)
#Checking misclassification error
mean(pred_log_dat$pred_Defaulter!=pred_data$SeriousDlqin2yrs)
#Calculating AUC curve
log.mod.roc<-roc(pred_data$SeriousDlqin2yrs,pred_log_dat$pred_Defaulter)
#AUC is .5066

#NaiveBayes
nb.mod<-naiveBayes(SeriousDlqin2yrs~age+scale(MonthlyIncome)+RevolvingUtilizationOfUnsecuredLines+NumberOfOpenCreditLinesAndLoans+NumberOfDependents+NumberOfTime60.89DaysPastDueNotWorse,data=credit_train)
pred_nb_mod<-predict(nb.mod,newdata = pred_data)
#Misclassification error
mean(pred_nb_mod!=pred_data$SeriousDlqin2yrs)
#error is .061586
#ROC
nb.roc<-roc(pred_nb_mod,as.numeric(pred_data$SeriousDlqin2yrs))
#AUC is .6951

               
#RandomForest
#Fitting a RF model on the train dataset and giving pred_col as test dataset.
rF.mod<-randomForest(SeriousDlqin2yrs~age+MonthlyIncome+RevolvingUtilizationOfUnsecuredLines+NumberOfOpenCreditLinesAndLoans+NumberOfDependents+NumberOfTime60.89DaysPastDueNotWorse,data = credit_train,xtest=pred_col,ytest=as.factor(pred_data$SeriousDlqin2yrs),ntree=200,importance=T)

#misclassification error
mean(rF.mod$test$predicted!=pred_data$SeriousDlqin2yrs)
#misclassification error rate is .0692
#ROC
rF.roc<-roc(pred_data$SeriousDlqin2yrs,as.numeric(rF.mod$test$predicted))
#AUC came out to be .5552


#Gradient Boosting Machine
gbm.mod<-gbm(as.character(SeriousDlqin2yrs)~age+DebtRatio+RevolvingUtilizationOfUnsecuredLines+NumberOfOpenCreditLinesAndLoans+NumberOfDependents+NumberOfTime60.89DaysPastDueNotWorse,distribution = "bernoulli",data=credit_train,n.trees = 1000,interaction.depth = 2,shrinkage = .01)
#Summary gives var influence chart
summary(gbm.mod)
#For predicting we create a var,so as to iterate over 1000 trees in chunks of 100's
n.tree<-seq(from=100,to=1000,by=100)
#Predicting on test
pred_gbm_mod<-predict.gbm(gbm.mod,pred_data,n.trees = n.tree,type = "response")
#Taking mean from predicted values 
pred_gbm_mod<-apply(pred_gbm_mod,1,mean)
#Classifying
pred_gbm_default<-ifelse(pred_gbm_mod>.5,1,0)
#Creating data frame of predicted classes
pred_gbm_mod<-as.data.frame(cbind(pred_gbm_mod,pred_gbm_default))
#misclassification error
mean(pred_gbm_mod$pred_gbm_default!=pred_data$SeriousDlqin2yrs)
#ROC
gbm.roc<-roc(pred_data$SeriousDlqin2yrs,pred_gbm_mod$pred_gbm_default)
#AUC turns out to be .5199

#XGBoost
#Fitting model
credit_col<-data.matrix(credit_train[,c("age","MonthlyIncome","RevolvingUtilizationOfUnsecuredLines","NumberOfOpenCreditLinesAndLoans","NumberOfDependents","NumberOfTime60.89DaysPastDueNotWorse")])
xgb.mod<-xgboost(data=credit_col,label =credit_pred,nrounds = 2,objective="binary:logistic")
#Predicting on pred_col using xgb.mod
pred_xgb_mod<-predict(xgb.mod,newdata =as.matrix(pred_col))
pred_xgb_default<-ifelse(pred_xgb_mod>.5,1,0)
#Creating a dataframe with pertinent classification
pred_xgb_mod<-cbind.data.frame(pred_xgb_mod,pred_xgb_default)
#misclassification error
mean(pred_data$SeriousDlqin2yrs!=pred_xgb_mod$pred_xgb_default)
#error is .187987
#Creating a roc object so as to get AUC
xgb.roc<-roc(pred_data$SeriousDlqin2yrs,pred_xgb_mod$pred_xgb_default)
#AUC is .6521


#SVM



```

```{r}
 
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
